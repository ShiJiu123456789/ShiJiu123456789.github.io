# 越界检测


## 姿势估计（YOLO）

训练模型：https://blog.csdn.net/qq_42452134/article/details/135205234

数据集：COCO-Pose

https://docs.ultralytics.com/zh/datasets/pose/coco/#sample-images-and-annotations

### 工具包

判断越界代码

    def is_point_on_segment(p, seg_p1, seg_p2):
        """判断点是否在线段上"""
        x, y = p
        x1, y1 = seg_p1
        x2, y2 = seg_p2
    
        # 计算叉积判断是否共线
        cross = (x2 - x1) * (y - y1) - (y2 - y1) * (x - x1)
        if abs(cross) > 1e-10:
            return False
    
        # 检查点是否在线段的包围盒内
        min_x = min(x1, x2)
        max_x = max(x1, x2)
        min_y = min(y1, y2)
        max_y = max(y1, y2)
    
        if not (min_x - 1e-10 <= x <= max_x + 1e-10):
            return False
        if not (min_y - 1e-10 <= y <= max_y + 1e-10):
            return False
    
        return True
    
    def is_point_in_polygon(point, polygon):
        """判断点是否在多边形内部"""
        x, y = point
        n = len(polygon)
        if n < 3:
            return False  # 非多边形
    
        # 检查点是否在任一边上
        for i in range(n):
            p1 = polygon[i]
            p2 = polygon[(i + 1) % n]
            if is_point_on_segment((x, y), p1, p2):
                return True
    
        # 使用射线法判断内部
        inside = False
        for i in range(n):
            p1 = polygon[i]
            p2 = polygon[(i + 1) % n]
            x1, y1 = p1
            x2, y2 = p2
    
            # 判断边是否跨越射线上方和下方
            if (y1 > y) != (y2 > y):
                # 计算交点x坐标
                t = (y - y1) / (y2 - y1)
                x_intersect = x1 + t * (x2 - x1)
                if x_intersect > x:
                    inside = not inside
    
        return inside

示例用法

    if __name__=='__main__':
        # 从左上角的点顺时针，给出多边形的每个点
        polygon = [(0, 0), (0, 2), (2, 2), (2, 0)]  # 矩形
        # polygon = [(0, 0), (0, 2), (1, 2), (2, 1), (2, 0)]  # 五边形
        point_inside = (1, 1)
        point_outside = (1, 2)
        point_on_edge = (1, 0)
    
        print(is_point_in_polygon(point_inside, polygon))    # 输出：True
        print(is_point_in_polygon(point_outside, polygon))   # 输出：False
        print(is_point_in_polygon(point_on_edge, polygon))  # 输出：True

### YOLO实现 {#YOLOcomplete}

引入库

    from ultralytics import YOLO
    import cv2
    import matplotlib.pyplot as plt
    import torch
    
    import sys
    sys.path.append("/home/zengz/zz/ll/Yolov11/")
    from utils.tools_area_foot import is_point_in_polygon,draw_s,draw
    
检测方法：

yolo对于没有检测到的关节点坐标设置为(0,0)
    
    #区域入侵检测，area为区域的坐标，bboxes_keypoints为人体关节点的坐标
    def detect(area, results):
        bboxes_xyxy = results[0].boxes.xyxy.cpu().numpy().astype('uint32')
        bboxes_keypoints = results[0].keypoints.data.cpu().numpy()
        num_bbox = len(results[0].boxes.cls)
    
        labels = []
        for idx in range(num_bbox):  # 遍历每个框
            bbox_xyxy = bboxes_xyxy[idx]
            center_x = (bbox_xyxy[0]+bbox_xyxy[2]) / 2
            center_y = (bbox_xyxy[1]+bbox_xyxy[3]) / 2
            center_point = (center_x, center_y)
    
            bbox_keypoints = bboxes_keypoints[idx]  # 该框所有关键点坐标和置信度
            Right_Knee_point = tuple(bbox_keypoints[13][:2])
            Left_Knee_point = tuple(bbox_keypoints[14][:2])
            Right_Ankle_point = tuple(bbox_keypoints[15][:2])
            Left_Ankle_point = tuple(bbox_keypoints[16][:2])
    
            label = False
            #如果没有检测到这几个关节，判断中心点是否越界
            if Right_Knee_point == (0,0) and Right_Knee_point == (0,0) and Right_Knee_point == (0,0) and Right_Knee_point == (0,0):
                center_label = is_point_in_polygon(center_point, area) 
                label = center_label
            else: #只要检测到一个脚的关节点，依照关节点判断
                if Right_Knee_point == (0,0): #防止没有检测到的关节点误判为关节点位置在(0,0)，形成区域入侵
                    Right_Knee_label = False
                else:
                    Right_Knee_label = is_point_in_polygon(Right_Knee_point, area)
                if Left_Knee_point == (0,0):
                    Left_Knee_label = False
                else:
                    Left_Knee_label = is_point_in_polygon(Left_Knee_point, area)
                if Right_Ankle_point == (0,0):
                    Right_Ankle_label = False
                else:
                    Right_Ankle_label = is_point_in_polygon(Right_Ankle_point, area)
                if Left_Ankle_point == (0,0):
                    Left_Ankle_label = False
                else:
                    Left_Ankle_label = is_point_in_polygon(Left_Ankle_point, area)
                label = Right_Knee_label or Left_Knee_label or Right_Ankle_label or Left_Ankle_label
                # print(Right_Knee_label, Left_Knee_label, Right_Ankle_label,Left_Ankle_label) 
    
            if label:
                labels.append(True) #True表示入侵
                print(center_point,Right_Knee_point, Left_Knee_point, Right_Ankle_point,Left_Ankle_point)
            else:
                labels.append(False)
        print(labels)
        return labels

使用示例：
    
    if __name__ == '__main__':
        # 有 GPU 就用 GPU，没有就用 CPU
        device = torch.device('cuda:0' if torch.cuda.is_available() else 'cpu')
        print('device:', device)
        # 载入预训练模型
        model = YOLO('/home/zengz/zz/ll/Yolov11/model/yolo11s-pose.pt')
        model.to(device)
        img_path = r'/home/zengz/zz/ll/Yolov11/dataset/pic/5.png'
        # results = model(img_path)
    
        results = model(
            source=img_path,
            classes=[0],     # 只检测人（COCO 类别 0）
            conf=0.2,  # 关键点置信度阈值
        )
    
        original_img = results[0].orig_img #(333, 137, 3) (width, height, 3)
    
        area = [(200,0),(400,300)]
        plogon = [(200,0),(400,0),(400,300),(200,300)]
    
        labels = detect(plogon, results)
    
        # #画图
        dir = '/home/zengz/zz/ll/Yolov11/detect_result/pose/5.png'
        draw(area, results, img_path, dir, labels)